<launch>
    <!-- 
        Launch file for the DUAL ARM perception pipeline.
        This starts the client nodes for both L_panda and R_panda and the external ZMQ servers.
    -->

    <!-- ===================================================================================== -->
    <!-- ARGUMENTS (Configuration) -->
    <!-- ===================================================================================== -->
    
    <!-- Port Configuration for ZMQ Servers -->
    <arg name="fastsam_server_port"     default="5556" doc="Port for the FastSAM ZMQ server."/>
    <arg name="left_grasp_server_port"  default="5557" doc="Port for the Left Arm GraspGen ZMQ server."/>
    <arg name="right_grasp_server_port" default="5558" doc="Port for the Right Arm GraspGen ZMQ server."/>

    <!-- General Parameters -->
    <arg name="visualize"     default="true" doc="Whether to show CV2 visualization windows."/>
    <arg name="top_k"         default="50"   doc="Number of top grasps to return (-1 for all)."/>
    <arg name="left_gripper"  default="finger"  doc="Left gripper type to be used by GraspGen." />
    <arg name="right_gripper" default="suction" doc="Right gripper type to be used by GraspGen." />
    <arg name="conda_env"     default="GraspGen" doc="Conda environment name where the servers are installed."/>

    <!-- ===================================================================================== -->
    <!-- Left Arm Group -->
    <!-- ===================================================================================== -->
    <group ns="L_panda">
        <arg name="arm_id" value="L_panda"/>
        
        <!-- FastSAM Client for the Left Arm -->
        <node name="fastsam_client_node" pkg="dual_arm_control" type="fastsam_client.py" output="screen">
            <param name="image_topic" value="/mujoco_server/cameras/$(arg arm_id)_camera_depth_frame/rgb/image_raw" />
            <param name="visualize"   value="$(arg visualize)" />
            <param name="port"        value="$(arg fastsam_server_port)" />
        </node>

        <!-- GraspGen Service for the Left Arm -->
        <node name="graspgen_service_node" pkg="dual_arm_control" type="grasp_client.py" output="screen">
            <param name="arm_id" value="$(arg arm_id)" />
            <param name="port"   value="$(arg left_grasp_server_port)" />
            <param name="top_k"  value="$(arg top_k)" />
            <param name="gripper_type" value="$(arg left_gripper)" />
        </node>
    </group>

    <!-- ===================================================================================== -->
    <!-- Right Arm Group -->
    <!-- ===================================================================================== -->
    <group ns="R_panda">
        <arg name="arm_id" value="R_panda"/>

        <!-- FastSAM Client for the Right Arm -->
        <node name="fastsam_client_node" pkg="dual_arm_control" type="fastsam_client.py" output="screen">
            <param name="image_topic" value="/mujoco_server/cameras/$(arg arm_id)_camera_depth_frame/rgb/image_raw" />
            <param name="visualize"   value="$(arg visualize)" />
            <param name="port"        value="$(arg fastsam_server_port)" />
        </node>

        <!-- GraspGen Service for the Right Arm -->
        <node name="graspgen_service_node" pkg="dual_arm_control" type="grasp_client.py" output="screen">
            <param name="arm_id" value="$(arg arm_id)" />
            <param name="port"   value="$(arg right_grasp_server_port)" />
            <param name="top_k"  value="$(arg top_k)" />
            <param name="gripper_type" value="$(arg right_gripper)" />
        </node>
    </group>

    <!-- ===================================================================================== -->
    <!-- Start ZMQ Servers (Bash Scripts) -->
    <!-- ===================================================================================== -->
    
    <!-- Start FastSAM Server Script (reads /start_fastsam_servers/* parameters) -->
    <node name="start_fastsam_servers" pkg="dual_arm_control" type="start_fastsam_server.sh" output="screen">
        <param name="conda_env" value="$(arg conda_env)" />
        <param name="port"      value="$(arg fastsam_server_port)" />
    </node>
    
    <!-- Start GraspGen Server Script (reads /start_graspgen_servers/* parameters) -->
    <node name="start_graspgen_servers" pkg="dual_arm_control" type="start_graspgen_server.sh" output="screen">
        <param name="conda_env"     value="$(arg conda_env)" />
        <param name="left_gripper"  value="$(arg left_gripper)" />
        <param name="right_gripper" value="$(arg right_gripper)" />
        <param name="left_port"     value="$(arg left_grasp_server_port)" />
        <param name="right_port"    value="$(arg right_grasp_server_port)" />
    </node>

</launch>